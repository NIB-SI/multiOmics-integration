```{r echo=FALSE}
###############################################
##                                           ##
## (c) Andrej Blejec (andrej.blejec@nib.si)  ##
##                                           ##
###############################################
```
```{r echo=FALSE,results='hide'}
options(width=70)
```


Child: 027-plot-networkdiff.rnw
### ... Plot `r paste(groups, collapse=", ") Network difference, cutoff = \Sexpr{cutoff`}

Correlation matrices, values above cutoff `r cutoff`.

```{r }
par(mfrow=c(1,2))
zlim <- c(-1,1)
r <- m1$M*(abs(m1$M)>cutoff)
nr <- nrow(r)
nc <- ncol(r)
r1 <- r
image(1L:nc, 1L:nr, t(r), xlim = 0.5 + c(0, nc), ylim = 0.5 +
+         c(0, nr), axes = FALSE, xlab = "", ylab = "", zlim=zlim, col=colsh)
abline(h=seq(0.5,nr),v=seq(0.5,nc),col="white")
axis(4,at=1:nr,rownames(r), las=2,cex.axis=0.7, line = -0.5, tick = 0)
axis(1,at=1:nc,colnames(r), las=2,cex.axis=0.7, line = -0.5, tick = 0, adj=1)
title(groups[1])
r <- m2$M*(abs(m2$M)>cutoff)
nr <- nrow(r)
nc <- ncol(r)
r2 <- r
image(1L:nc, 1L:nr, t(r), xlim = 0.5 + c(0, nc), ylim = 0.5 +
+         c(0, nr), axes = FALSE, xlab = "", ylab = "", zlim=zlim, col=colsh)
abline(h=seq(0.5,nr),v=seq(0.5,nc),col="white")
axis(1,at=1:nc,colnames(r), las=2,cex.axis=0.7, line = -0.5, tick = 0, adj=1)
title(groups[2])
```

```{r }
par(mfrow=c(1,2))
r <- (r2-r1)
nr <- nrow(r)
nc <- ncol(r)
zlim=c(-2,2)
image(1L:nc, 1L:nr, t(r), xlim = 0.5 + c(0, nc), ylim = 0.5 +
+         c(0, nr), axes = FALSE, xlab = "", ylab = "", zlim=zlim, col=colsh)
abline(h=seq(0.5,nr),v=seq(0.5,nc),col="white")
axis(4,at=1:nr,rownames(r), las=2,cex.axis=0.7, line = -0.5, tick = 0)
axis(1,at=1:nc,colnames(r), las=2,cex.axis=0.7, line = -0.5, tick = 0, adj=1)
title(paste(groups[2], "-", groups[1]))
for (i in 1:nr) {
#    print(cbind(r2=r2[i,], r1=r1[i,], r2.r1=(r2-r1)[i,]))
    dif <- (r2 != r1)
    col <- c(0,2)[dif[i,]+1]
    points(1:nc,i+r2[i,]/3,col=col, pch=16, cex=0.5)
        col <- c(0,4)[dif[i,]+1]
    points(1:nc,i+r1[i,]/3,col=col, pch=16,cex=0.5)
  }
  legend <- c(paste(groups[2],groups[1],sep=" > "),
              paste(groups[2],groups[1],sep=" < "))
legend("topright",col=colsh[c(5,15)], pch=c(15,15), legend=legend, bty="n", xpd=TRUE, pt.cex=2,inset=c(-0,-0.4)
)
```


```{r }
set.seed(1234)
n1 <- network(toBinary(m1$M, cutoff),cutoff=cutoff
    , shape.node = c("rectangle","rectangle")
    , color.node = c(col1,col2)
    , layout = layout_in_circle
)
title(paste(groups[1],"Cutoff =", cutoff),adj=1)
```

```{r }
set.seed(1234)
n2 <- network(toBinary(m2$M, cutoff),cutoff=cutoff
    , shape.node = c("rectangle","rectangle")
    , color.node = c(col1,col2)
    , layout = layout_in_circle
)
title(paste(groups[2],"Cutoff =", cutoff),adj=1)
```

Prepare matrices of edge inconsistencies in networks:

```{r }

N1 <- n1$M!=0
N2 <- n2$M!=0
table(N1,N2)
N21 <- (N2&!N1)+0
N12 <- (N1&!N2)+0

```

```{r }
set.seed(1234)
n21 <- network(N21*n2$M, cutoff=cutoff
    , shape.node = c("rectangle","rectangle")
    , color.node = c(col1,col2)
    , layout = layout_in_circle
)
title(
main=paste("Present in", groups[2], "but not in", groups[1],": cutoff", cutoff)
, sub = paste(datasets, collapse=", ")
)

```



```{r }
set.seed(1234)
n12 <- network(N12*n1$M, cutoff=cutoff
    , shape.node = c("rectangle","rectangle")
    , color.node = c(col1,col2)
    , layout = layout_in_circle
)
title(
main=paste("Present in", groups[1], "but not in", groups[2],": cutoff", cutoff)
, sub = paste(datasets, collapse=", ")
)
```



```{r fig.length=20, fig.width=8}

set.seed(1234)
n21 <- network(N21*n2$M, cutoff=cutoff
    , shape.node = c("rectangle","rectangle")
    , color.node = c(col1,col2)
    , layout = layout_in_circle
)
title(
main=paste("Present in", groups[2], "but not in", groups[1],": cutoff", cutoff)
, sub = paste(datasets, collapse=", ")
)

```

Function `circosPlot()` plots and returns similarities between features.
Similarities between features are products of correlations of features and scores on corresponding canonical variate.

Similarity for features $i$ from dataset $X_I$ and feature $j$ from dataset $X_J$ is

$$s_{I_i,J_j} = cor( X_{I,i}, CV_I ) * cor( X_{J,j}, CV_J)$$

If both correlations are $0.7$, similarity is $0.49$, so cutoff $0.5$ is selecting correlations that are (on average) above $0.7$.

Square root of $s_{I_i,J_j}$ would be geometric mean of two correlations and might give a more plausible scale.

We are interested in connections between features from different datasets, so parallel linear representation might be more readable.

```{r }
network_parallel <- function(data, legend=FALSE){
    maxy <- max(sapply(data, dim))
    plot(0,0, xlim=c(0.5,length(data)*2+0.5), ylim=c(maxy,0), type="n", ann=FALSE, axes=FALSE, xpd=TRUE)
    x <- data[[1]]
    text(rep(1, nrow(x)), 1:nrow(x), rownames(x), adj=1, xpd=TRUE)
    text(rep(2, ncol(x)), 1:ncol(x), colnames(x), adj=0, xpd=TRUE)
    x1 <- rep(1, ncol(x))+0.025
    x2 <- rep(2, ncol(x))-0.025
    cols <- c(3,0,2)
    for( i in 1:nrow(x)){
        segments(x1,rep(i,ncol(x)),x2,1:ncol(x), col=cols[sign(x[i,])+2],
        lwd=abs(x[i,])*3)
        }
    if(legend) legend("topleft",cex=1, col=cols[c(1,3)],legend=c("-","+"), bty="n", horiz=!TRUE, inset=c(-0.3,-0.05), xpd=TRUE, pt.cex=1, lwd=2)
}
if(interactive()) network_parallel( list(N12*n1$M), legend=TRUE )
```
```{r }
nmax <- max(dim(N12))
long <- (nmax> 50)
long
```
```{r }
par(mfrow=c(1,2))
network_parallel( list(N12*m1$M), legend=TRUE )
title(
main=paste("Present in", groups[1], "but not in", groups[2],"\ncutoff", cutoff) , sub = paste(datasets, collapse=", "))
network_parallel( list(N21*m2$M) )
title(
main=paste("Present in", groups[2], "but not in", groups[1],"\ncutoff", cutoff)
, sub = paste(datasets, collapse=", ")
)
```

```{r fig.width=15, fig.height=15,out.width=400,out.height="15cm"}
par(mfrow=c(1,2))
network_parallel( list(N12*m1$M), legend=TRUE )
title(
main=paste("Present in", groups[1], "but not in", groups[2],"\ncutoff", cutoff) , sub = paste(datasets, collapse=", "))
network_parallel( list(N21*m2$M) )
title(
main=paste("Present in", groups[2], "but not in", groups[1],"\ncutoff", cutoff)
, sub = paste(datasets, collapse=", ")
)
```

