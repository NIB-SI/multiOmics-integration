---
title: "Integration across different omics datasets"
author: "Andrej Blejec"
date: 28. 4. 2024
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    code_folding: show
---

```{r Author:,echo=FALSE}
###############################################
##                                           ##
## (c) Andrej Blejec (andrej.blejec@nib.si)  ##
##                                           ##
###############################################
```

```{r include=FALSE, message=FALSE, warnings=FALSE, cache=FALSE}
require(knitr)
render_markdown()
opts_chunk$set( fig.path='./figs/'
    , tidy=FALSE)
opts_knit$set( concordance=TRUE
    , root.dir = getwd() # working directory for all chunks
    , unnamed.chunk.label = "ch"
    , width = 70
)
opts_knit$get("root.dir")
```

# Introduction

[Needs more text]

In this document we present a work-flow for integration across different omics datasets.

[Note] This is not the final version of the document.

# Packages and files


A package with regularized CCA and multiomics DIABLO method is *mixOmics*. Package *igraph* is needed for network analysis.

```{r message=FALSE,warning=FALSE}
library(mixOmics)
library(igraph)
```

Package for complex heatmaps.
```{r message=FALSE,warning=FALSE}
#BiocManager::install("ComplexHeatmap")
library(ComplexHeatmap)
# https://www.rdocumentation.org/packages/pheatmap/versions/1.0.12/topics/pheatmap
library(pheatmap)
```

## Functions

Some original and adapted functions can be found in the file that is silently processed here.

%% Additional functions
```{r result='hide'}
out <- ""
out <- paste(out,knit_child("005-Functions.Rmd", quiet=TRUE))
```

## File names

Usually we use a file management system under the pISA-tree framework. 
For simplicity, all files ( scripts, data ,... ) are in one directory.

Sample description file (aka phenodata)
```{r }
pfn <- "phenodata_20221001.txt"
```

Data file names

```{r}
file1 <- "data_hormonomics.txt"
file2 <- "data_metabolomics.txt"
file3 <- "data_qPCR.txt"
```

For future use and labeling, we need text names of dataset objects.
```{r}
datanames <- c("hormonomics",  "metabolomics", "qPCR")
```


It is advisable to first read the phenodata, followed by actual data input. This enables smart selection of samples, based on the sample selection column with the assay name.

## Phenodata

```{r }
#(pfn <- getMeta(.ameta
#    , "Phenodata"))
# phenodata file name
pfn
#
phdata <- read.table(pfn
  , header = TRUE
  ,  sep = "\t"
  , stringsAsFactors = FALSE
  , row.names=1
  )
dim(phdata)
names(phdata)
pdata <- phdata
```

Overview of selected samples:

```{r }
table(pdata$Treatment, pdata$SamplingDay)
.treat <- unique(pdata$Treatment)
.days <- unique(pdata$SamplingDay)
.entry <- 0.5

```

```{r }
summary(pdata)
apply(pdata,2,function(x) summary(as.factor(x)))
```

## Process data files

For this project we aim to integrate several multi-omics datasets.
We have data on hormonomics, metabolomics, and qPCR:


```{r}
hormonomics <- read.table(file1, header=TRUE, sep="\t")
metabolomics <- read.table(file2, header=TRUE, sep="\t")
qPCR <- read.table(file3, header=TRUE, sep="\t")
```

List dataset names
```{r}
datanames
```

## Combine datasets

Datasets for DIABLO need to be collected in a list, with rows corresponding to the same samples. The order of samples from shrinked phenodata will be enforced.

The first component of the list will be a grouping variable, indicating the conditions. We will create reasonable names for groups.

```{r}
sday <- paste0(0,pdata$SamplingDay)
len <- nchar(sday)
sday <- substr(sday,len-1,len)
what <- paste(pdata$Treatment,sday,sep="")
X <- list(status= what)
names(X[[1]]) <- rownames(pdata)
X
```

### Experimental: randomization

One idea is to randomize treatments by permuting the combined status codes before attributing them to the actual dsample conditions.

```{r}
# prefix short numbers with zero
sday <- paste0(0,pdata$SamplingDay)
len <- nchar(sday)
sday <- substr(sday,len-1,len)
trt <- pdata$Treatment
what <- paste(trt,sday,sep="")
what
X <- list(status= what)
names(X[[1]]) <- rownames(pdata)
X
```



```{r}
print(addmargins(table(pdata$SamplingDay, what)), zero.print=".")
print(addmargins(table(pdata$Treatment, what)), zero.print=".")
```
Put datasets into list X and ensure that they all have same order of samples as in phenodata.
```{r}
datanames
i <- 1
for(i in 1:length(datanames)){
x <- get(datanames[i])
rownames(x) <- x[,1]
x <- x[,-1]
X[[i+1]] <- x[rownames(pdata),]
names(X)[i+1] <- datanames[i]
}
str(X)
names(X)
```

Check if sample names in all datasets match.
```{r}
OK <- TRUE
for(i in 2:length(X)) {
print(ok <- all(names(X[[1]])==rownames(X[[i]])))
OK <- OK&ok
}
```

```{r, echo=FALSE, results='asis'}
if(OK) catln("Sample names in datasets match.") else catln("ERROR: Sample names in datasets do not match!!")
```

Put data into safe object `DATA`. 

```{r}
DATA <- X
```

We will also need the names of treatment groups.

```{r}
groups <- unique(pdata$Treatment)
groups
```

# Multiomics data integration with DIABLO

```{r}
CCDATA <- DATA
names(CCDATA)
```



```{r }
write("Entering 035-DIABLO !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!", "bla.log", append=!TRUE)
write("commandArgs:", "bla.log", append=TRUE)
write(commandArgs(trailingOnly = TRUE), "bla.log",append=TRUE)
write("End commandArgs", "bla.log", append=TRUE)
```

```{r diablo, results='asis'}
out <- ""
out <- paste(out,knit_child("035-DIABLO-2.Rmd", quiet=TRUE))
cat(out)
```

```{r}
write("From 035-DIABLO !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!", "bla.log", append=TRUE)
```


# SessionInfo

```{r sessionInfo,results='asis',echo=FALSE}
cat(win.version(),"<br>")
sessionInfo()
```
