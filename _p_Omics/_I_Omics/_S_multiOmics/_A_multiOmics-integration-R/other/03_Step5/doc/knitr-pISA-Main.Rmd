---
title: "Data integration"
author: "Andrej Blejec"
date: 16. 1. 2023
output:
  html_document:
    toc: true
    number_sections: true
    code_folding: show
---

```{r Author:,echo=FALSE}
###############################################
##                                           ##
## (c) Andrej Blejec (andrej.blejec@nib.si)  ##
##                                           ##
###############################################
```

```{r include=FALSE, message=FALSE, warnings=FALSE, cache=FALSE}
require(knitr)
render_markdown()
opts_chunk$set( fig.path='./figs/'
    , tidy=FALSE)
opts_knit$set( concordance=TRUE
    , root.dir = getwd()
    , unnamed.chunk.label = "ch"
    , width = 70
)
opts_knit$get("root.dir")
```

```{r additional arguments, echo=FALSE, message=FALSE, warnings=FALSE}
addArgs <- NULL
addArgs[1] <- c("")[1]
```

# Purpose of this document

# File management system

Files are managed under the pISA-tree framework. To take advantage of pISA-tree metadata information, we will use package `pisar`
```{r}
library(pisar)
pisa <- pisa()

```

```{r set specific arguments,results='hide',message=FALSE,warning=FALSE,echo=FALSE}
# Argumenti
# 1. Ime izvorne datoteke za analizo
# 2. Izbira genov (ime stolpca v featuredata)
#
 .callName <- addArgs[1]
 .vzorci <- addArgs[2]
#getwd()
#args
```

```{r initialize,echo=FALSE,include=FALSE,message=FALSE,warning=FALSE}
options(width=70)
library(Hmisc)
library(amisc)
#library(Biobase)
#library(xlsReadWrite)
library(xtable)
#library(MASS)
```

Final document is in subdirectory `reports`:
```{r }
basename(outputFile)
```

## Info from pISA structure

Input/data directory

```{r }
.inroot
```

Results directory

```{r }
.oroot
```

```{r echo=FALSE}
catln("project:\t",     .pname)
catln("Investigation: ",.iname)
catln("Study:         ",.sname)
catln("Assay:         ",.aname)
```

# Data

It is advisable to first read phenodata and featuredata, followed by actual data input. This enables smart selection of samples, based on the sample selection column with the assay name.

## Phenodata

```{r }
(pfn <- getMeta(.ameta
    , "Phenodata"))
dir(file.path(.aroot,dirname(pfn)), pattern = basename(pfn))
phdata <- read.table(file.path(.aroot,pfn)
  , header = TRUE
  ,  sep = "\t"
  , stringsAsFactors = FALSE
  , row.names=1
  )
dim(phdata)
names(phdata)
```


Check and use the sample selection column, if present.
```{r }
.aname
selectId <- substr(gsub("-",".",.aname),2,nchar(.aname))
selectId <- .vzorci
selectId
if(selectId %in% names(phdata)) pdata <- phdata[!is.na(phdata[,selectId]),] else
pdata <- phdata
dim(pdata)
```

Selected samples overview

```{r }
table(pdata$Treatment, pdata$SamplingDay)
```

```{r }
summary(pdata)
apply(pdata,2,function(x) summary(as.factor(x)))
```

## Featuredata

```{r }
(ffn <- getMeta(.ameta,"Featuredata"))
```

```{r }
if(ffn != "")
fdata <- read.table(file.path(.iroot,ffn)
    , sep = "\t"
    , header = TRUE
    , na.strings = c("", "-")
    , stringsAsFactors = FALSE
    , row.names = 1
    ) else fdata <- NULL
head(fdata)
```

First few columns, if present.

```{r }
fdata[,1:2]
```

## Process data files


## Child

```{r child, results='asis'}
out <- ""
out <- paste(out,knit_child("child.Rmd", quiet=TRUE))
cat(out)
```
Another way
`r out`

# Metadata files

## Project

```{r echo=FALSE,results='asis'}
.pmeta
```

## Investigation

```{r echo=FALSE,results='asis'}
.imeta
```

## Study

```{r echo=FALSE,results='asis'}
.smeta
```

## Assay

```{r echo=FALSE,results='asis'}
.ameta
```

# SessionInfo

```{r sessionInfo,results='asis',echo=FALSE}
cat(win.version(),"<br>")
sessionInfo()
prefix <- "<a href='file:///"
suffix <- "/</a><br>"
sdir <- gsub("/","/<br> ",dirname(getwd()))
#cat("Project path:<br>",sdir,"<br>")
args <- commandArgs(trailingOnly = TRUE)
mainFile <- basename(args[1])
#
mainFilePath <- file.path("../doc", mainFile)
mainFilePath <- gsub("/./","/",mainFilePath)
projectName <- rev((strsplit(dirname(getwd()), "/"))[[1]])[1]
#
sdir <- dirname(getwd())
sdir <- strsplit(sdir,split="/")[[1]]
cdir <- sapply(1:length(sdir),function(x) paste(sdir[1:x],collapse="/"))
#
#cat("<br>Project path: [\\href{run:",
#dirname(getwd()),
#"}{link}]\\\\<br>",sep="")
##


cat("<br>Project path:<br><br>")
for(i in 1:length(sdir)) cat(
   prefix, cdir[i], "'>", sdir[i],suffix, "<wbr>\n",sep=""
   )

# <a href="file:///C:\Programs\sort.mw">Link 1</a>
cat("Main file :`", mainFilePath, "`<br>")
#
mainFile <- strsplit(mainFile,'.',fixed=TRUE)[[1]][1]
projectName <- rev((strsplit(dirname(getwd()), "/"))[[1]])[1]
cat("Project file: [\\href{run:",
file.path(dirname(getwd()),paste0(projectName,".prj")),
"}{link}]<br>",sep="")
#
``` 